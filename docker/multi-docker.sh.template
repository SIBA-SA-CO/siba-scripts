#!/bin/bash

# Funci√≥n para mostrar ayuda
mostrar_ayuda() {
  cat << EOF
Uso: $0 <comando_docker> <ruta1> <ruta2> ... [OPCIONES]

DESCRIPCI√ìN:
  Ejecuta comandos Docker Compose en m√∫ltiples directorios de forma segura.

PAR√ÅMETROS:
  <comando_docker>    Comando Docker Compose a ejecutar (ej: 'ps', 'up -d')
  <ruta1> <ruta2> ... Uno o m√°s directorios que contengan docker-compose.yml

OPCIONES:
  -h, --help          Muestra esta ayuda y sale
  -v, --version       Muestra la versi√≥n del script
  -l, --list          Lista comandos permitidos
  --dry-run           Muestra qu√© comandos se ejecutar√≠an sin ejecutarlos realmente

COMANDOS PERMITIDOS:
  ps, up, down, logs, restart, stop, start, build, pull

EJEMPLOS:
  $0 'ps' /ruta/proyecto1 /ruta/proyecto2
  $0 'up -d' /ruta/api /ruta/frontend
  $0 'logs --tail=10' /ruta/microservicio
  $0 'restart' /ruta/app1 /ruta/app2 /ruta/app3

CARACTER√çSTICAS DE SEGURIDAD:
  - Lista blanca de comandos permitidos
  - Validaci√≥n de opciones seguras
  - Sin uso de eval()
  - Verificaci√≥n de archivos docker-compose.yml
EOF
}

# Funci√≥n para mostrar versi√≥n
mostrar_version() {
  echo "Docker Multi-Compose v0.1.0"
  echo "Script seguro para ejecutar comandos Docker Compose en m√∫ltiples directorios"
}

# Funci√≥n para listar comandos permitidos
listar_comandos() {
  echo "Comandos Docker Compose permitidos:"
  echo "  ps        - Listar contenedores"
  echo "  up        - Iniciar servicios"
  echo "  down      - Detener servicios"
  echo "  logs      - Mostrar logs"
  echo "  restart   - Reiniciar servicios"
  echo "  stop      - Detener servicios"
  echo "  start     - Iniciar servicios"
  echo "  build     - Construir im√°genes"
  echo "  pull      - Descargar im√°genes"
  echo ""
  echo "Opciones comunes permitidas:"
  echo "  -d        - Ejecutar en segundo plano"
  echo "  --build   - Reconstruir im√°genes"
  echo "  --tail=N  - Mostrar √∫ltimas N l√≠neas de logs"
}

# Funci√≥n para dry-run
mostrar_dry_run() {
  local comando="$1"
  shift
  echo "=== SIMULACI√ìN (dry-run) ==="
  for ruta in "$@"; do
    if [ -f "$ruta/docker-compose.yml" ] || [ -f "$ruta/docker-compose.yaml" ]; then
      echo "‚úÖ Ejecutar√≠a: cd '$ruta' && docker compose $comando"
    else
      echo "‚ùå No ejecutar√≠a: docker-compose.yml no encontrado en '$ruta'"
    fi
  done
  echo "============================="
}

# Verificar opciones de ayuda
for arg in "$@"; do
  case $arg in
    -h|--help)
      mostrar_ayuda
      exit 0
      ;;
    -v|--version)
      mostrar_version
      exit 0
      ;;
    -l|--list)
      listar_comandos
      exit 0
      ;;
    --dry-run)
      DRY_RUN=true
      shift
      ;;
  esac
done

# Verifica si hay al menos un par√°metro
if [ "$#" -lt 1 ]; then
  echo "Error: Se requiere al menos un par√°metro."
  echo "Use '$0 --help' para m√°s informaci√≥n."
  exit 1
fi

# Lista de comandos seguros permitidos
comandos_seguros=("ps" "up" "down" "logs" "restart" "stop" "start" "build" "pull")

# Funci√≥n para validar y parsear el comando
validar_comando() {
  local comando_original="$1"
  
  # Convertir a min√∫sculas para comparaci√≥n
  local comando_lower=$(echo "$comando_original" | tr '[:upper:]' '[:lower:]')
  
  # Extraer el comando base (primera palabra despu√©s de 'docker compose')
  local comando_base=""
  if [[ "$comando_lower" =~ ^docker[[:space:]]+compose[[:space:]]+([a-z-]+) ]]; then
    comando_base="${BASH_REMATCH[1]}"
  elif [[ "$comando_lower" =~ ^docker-compose[[:space:]]+([a-z-]+) ]]; then
    comando_base="${BASH_REMATCH[1]}"
  else
    # Asumir que es solo el comando base
    comando_base="$comando_original"
  fi
  
  # Limpiar comando base (solo primera palabra)
  comando_base=$(echo "$comando_base" | awk '{print $1}')
  
  # Verificar si el comando base est√° en la lista blanca
  local es_seguro=0
  for cmd in "${comandos_seguros[@]}"; do
    if [ "$comando_base" = "$cmd" ]; then
      es_seguro=1
      break
    fi
  done
  
  if [ $es_seguro -eq 0 ]; then
    echo "Error: Comando '$comando_base' no permitido por seguridad."
    echo "Use '$0 --list' para ver los comandos permitidos."
    return 1
  fi
  
  echo "$comando_original"
  return 0
}

# El primer par√°metro es el comando Docker que se desea ejecutar
comando_original="$1"
shift  # Elimina el primer par√°metro para dejar solo las rutas

# Validar el comando
comando_validado=$(validar_comando "$comando_original")
if [ $? -ne 0 ]; then
  exit 1
fi

# Verifica si quedaron rutas
if [ "$#" -eq 0 ]; then
  echo "Error: debes indicar al menos una ruta despu√©s del comando."
  echo "Use '$0 --help' para m√°s informaci√≥n."
  exit 1
fi

# Si es dry-run, mostrar simulaci√≥n y salir
if [ "$DRY_RUN" = true ]; then
  mostrar_dry_run "$comando_validado" "$@"
  exit 0
fi

# Funci√≥n para ejecutar comando de forma segura
ejecutar_comando_seguro() {
  local ruta="$1"
  local comando="$2"
  
  echo "‚û° Ejecutando comando en: $ruta"
  
  # Ejecutar en el directorio destino
  (
    cd "$ruta" || { echo "‚ùå Error: No se puede acceder a $ruta"; return 1; }
    
    # Verificar nuevamente que docker-compose.yml existe
    if [ ! -f "docker-compose.yml" ] && [ ! -f "docker-compose.yaml" ]; then
      echo "‚ùå Error: docker-compose.yml no encontrado en $ruta"
      return 1
    fi
    
    # Ejecutar el comando
    echo "üìã Comando: docker compose $comando"
    if docker compose $comando; then
      echo "‚úÖ Comando ejecutado correctamente en $ruta"
    else
      echo "‚ùå Error al ejecutar comando en $ruta"
      return 1
    fi
  )
}

# Contadores para estad√≠sticas
total_rutas=$#
rutas_exitosas=0
rutas_fallidas=0

echo "üöÄ Iniciando ejecuci√≥n en $total_rutas directorio(s)..."
echo ""

# Itera sobre las rutas
for ruta in "$@"; do
  if [ -f "$ruta/docker-compose.yml" ] || [ -f "$ruta/docker-compose.yaml" ]; then
    if ejecutar_comando_seguro "$ruta" "$comando_validado"; then
      ((rutas_exitosas++))
    else
      ((rutas_fallidas++))
    fi
  else
    echo "‚ö† Archivo docker-compose.yml no encontrado en: $ruta"
    ((rutas_fallidas++))
  fi
  echo "---"
done

# Mostrar resumen
echo "üìä RESUMEN EJECUCI√ìN:"
echo "   Total de directorios: $total_rutas"
echo "   ‚úÖ Ejecuciones exitosas: $rutas_exitosas"
echo "   ‚ùå Ejecuciones fallidas: $rutas_fallidas"

if [ $rutas_fallidas -eq 0 ]; then
  echo "üéâ ¬°Todas las ejecuciones fueron exitosas!"
  exit 0
else
  exit 1
fi