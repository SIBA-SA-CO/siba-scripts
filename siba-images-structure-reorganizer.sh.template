#!/bin/bash
# ============================================================================
# Script: siba-images-structure-reorganizer.sh
# Autor: Edwar
# Fecha: 2025-10-30
#
# Descripci√≥n general:
# ----------------------------------------------------------------------------
#   Este script reorganiza TODAS las im√°genes ubicadas en una carpeta base
#   movi√©ndolas a subcarpetas basadas en los DOS PRIMEROS CARACTERES del nombre
#   de archivo. Es compatible con nombres MD5 o cualquier otro tipo de nombre.
#
#   Ejemplo:
#     8a7d2bc9e2e493d4c5e9a3a0b8f12b9f.jpg ‚Üí ./8a/8a7d2bc9e2e493d4c5e9a3a0b8f12b9f.jpg
#     logo_principal.png                  ‚Üí ./lo/logo_principal.png
#
#   Esto permite mejorar:
#     - El rendimiento en sistemas de archivos con muchas im√°genes.
#     - La indexaci√≥n y sincronizaci√≥n con CDN o servicios de cach√©.
#     - La organizaci√≥n interna del contenido multimedia.
#
# ----------------------------------------------------------------------------
# Uso:
#   ./siba-images-structure-reorganizer.sh /ruta/a/imagenes
#
# Ejemplo pr√°ctico:
#   ./siba-images-structure-reorganizer.sh /var/www/media/images
#
# Resultados esperados:
#   /var/www/media/images/
#     ‚îú‚îÄ‚îÄ 8a/
#     ‚îÇ    ‚îî‚îÄ‚îÄ 8a7d2bc9e2e493d4c5e9a3a0b8f12b9f.jpg
#     ‚îú‚îÄ‚îÄ lo/
#     ‚îÇ    ‚îî‚îÄ‚îÄ logo_principal.png
#     ‚îî‚îÄ‚îÄ po/
#          ‚îî‚îÄ‚îÄ portada.jpg
#
# ----------------------------------------------------------------------------
# Requisitos:
#   - Bash 4.0 o superior.
#   - Permisos de escritura sobre la carpeta base.
#   - Espacio suficiente en disco para mover los archivos.
#
# ----------------------------------------------------------------------------
# Notas importantes:
#   - Este script MUEVE los archivos (no los copia).
#   - Si el proceso se interrumpe, los archivos ya movidos no se perder√°n,
#     pero la ejecuci√≥n deber√° relanzarse para completar los faltantes.
#   - Es compatible con rutas relativas o absolutas.
#   - No altera archivos dentro de subcarpetas existentes (solo nivel ra√≠z).
# ============================================================================

# === Validaci√≥n de par√°metros de entrada ===
if [ -z "$1" ]; then
  echo "‚ùå Error: Debes indicar la ruta base."
  echo "Uso: $0 /ruta/a/imagenes"
  exit 1
fi

BASE="$1"

# Verifica que la ruta sea un directorio v√°lido
if [ ! -d "$BASE" ]; then
  echo "‚ùå Error: La ruta '$BASE' no existe o no es un directorio v√°lido."
  exit 1
fi

# Cambia al directorio base
cd "$BASE" || { echo "‚ùå No se pudo acceder a $BASE"; exit 1; }

echo "üöÄ Iniciando reorganizaci√≥n de im√°genes en: $BASE"
echo "---------------------------------------------"

# Inicializa contador total
count_total=0

# === Bucle principal de reorganizaci√≥n ===
# Usa find con -print0 para manejar nombres con espacios o caracteres especiales
while IFS= read -r -d '' file; do
  # Obtiene el nombre base del archivo (sin ruta)
  name=$(basename "$file")

  # Extrae los dos primeros caracteres como prefijo
  prefix=${name:0:2}

  # Crea la carpeta si no existe
  mkdir -p "$prefix"

  # Mueve el archivo a la carpeta correspondiente
  mv "$file" "$prefix/$name"

  # Incrementa el contador
  ((count_total++))

  # Muestra progreso cada 1000 archivos
  if (( count_total % 1000 == 0 )); then
    echo "üì¶ Procesadas $count_total im√°genes..."
  fi
done < <(find . -maxdepth 1 -type f -print0)

# === Reporte final ===
echo "---------------------------------------------"
echo "‚úÖ Reorganizaci√≥n completa en $BASE"
echo "üìä Total de archivos procesados: $count_total"
echo "üïí Fecha de finalizaci√≥n: $(date '+%Y-%m-%d %H:%M:%S')"

